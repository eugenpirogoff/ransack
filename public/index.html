<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="utf-8">
    <title>Ransack</title>

<link href="css/style.css" rel="stylesheet">
<link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/css/bootstrap-combined.min.css" rel="stylesheet">
<script type="text/javascript" src="//maps.google.com/maps/api/js?sensor=true"></script>
<script type="text/javascript" src="js/jquery-1.8.2.js"></script>
<script type="text/javascript" src="js/scripts.js"></script>
<script type="text/javascript" src="js/gmaps.js"></script>
<script type="text/javascript" src="js/bootstrap-dropdown.js"></script>
<script type="text/javascript">
$(document).ready(function(){
    
});

  </script>

  </head>
  <body>
  <div class="navbar navbar-fixed-top">
  <div class="navbar-inner">
    <div class="container">
      <!-- Collapsable nav bar -->
      <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </a>
      <a class="brand">Ransack</a>
      <div class="nav-collapse">
        <ul class="nav">
          <li class="active">
            <a href="/">
              <i class="icon-home">
              </i>
              Home
            </a>
          </li>
          <li class="divider-vertical"></li>
        </ul>
        <!-- Searchcomponents -->
        <ul class="nav">
        <div class="navbar-form pull-center">
          <select class="input-small" id="formradius" name="formradius">
          	<option>1</option>
          	<option>5</option>
            <option>10</option>
            <option>20</option>
            <option>30</option>
            <option>40</option>
            <option>50</option>
          </select>
          <input class="span2" id="formcoord1" name="formcoord1" type="text" placeholder="Latitude"> 
          <input class="span2" id="formcoord2" name="formcoord2" type="text" placeholder="Longtitude"> 
          <button id="searchbutton" class="btn"><i class="icon-search">
              </i>Search</button>
        </div>
        </ul>

        <ul class="nav pull-right">
          <li id="signup_dropdown" class="dropdown">
          	<a class="dropdown-toggle" href="#" data-toggle="dropdown">Sign Up</a>
          	<div class="dropdown-menu" style="padding: 15px; padding-bottom: 0px;">
          	<form action="/signup" method="post" accept-charset="UTF-8">
              <input id="user_username" style="margin-bottom: 15px;" type="text" name="username" placeholder="username" size="30" />
              <input id="user_email" style="margin-bottom: 15px;" type="email" name="email" placeholder="email" size="30" />
              <input id="user_password" style="margin-bottom: 15px;" type="password" name="password" placeholder="password" size="30" />
              <input id="user_password_confirm" style="margin-bottom: 15px;" type="password" name="password_confirm" placeholder="password(repeat)" size="30" />
              <button class="btn btn-primary" style="clear: left; width: 100%; height: 32px; font-size: 13px;"> Sign Up </button>
            </form>
          	</div>
          </li>
          <li class="divider-vertical"></li>
          <li id="signin_dropdown" class="dropdown">
            <a id="userDropdownLink" class="dropdown-toggle" href="#" data-toggle="dropdown"><i class="icon-user">
              </i>Sign In <strong class="caret"></strong></a>
            <div id="userDropdown" class="dropdown-menu" style="padding: 15px; padding-bottom: 10px;">
              <input id="username" style="margin-bottom: 15px;" type="text" name="formusername" placeholder="username"size="30" />
              <input id="password" style="margin-bottom: 15px;" type="password" name="formpassword" placeholder="password" size="30" />
             
              <button id="loginbutton" class="btn btn-primary" style="clear: left; width: 100%; height: 32px; font-size: 13px;" name="commit" value="Sign In"> Sign In</button>
            </div>
          </li>
        </ul>
      </div>
    </div>
  </div>
</div>
<div class="mymap" id="map">
</div>
<script>


$(document).ready(function() {
  var map;
    var overlay;
    map = new GMaps({
      div: '#map',
        lat: -12.043333,
        lng: -77.028333,
        click: function(e) {

          /*
          mir ist klar das hier die coordinaten von dem Event zum einfach Pin hinclicken hinsollten, aber das funzt noch ned.
          Darum auch erst ein mal den mittelpunkt genommen. Sorry Bro!        
          var lat = e.latLng.$a;
          var lng = e.latLng.ab;
          */
          var lat = map.getCenter().lat();
          var lng = map.getCenter().lng();

          map.removeOverlays(overlay);
          overlay = map.drawOverlay({
            lat: lat,
            lng: lng,
            content: '<img src="img/icon_pin.png" class="icon_pin">',
            verticalAlign: 'top',
            horizontalAlign: 'center'
          });
          $('#formcoord1').val(lat);
          $('#formcoord2').val(lng);
        },
        dragend: function(e) {
          var lat = map.getCenter().lat();
          var lng = map.getCenter().lng();
          
          map.removeOverlay(overlay);
          overlay = map.drawOverlay({
            lat: lat,
            lng: lng,
            content: '<img src="img/icon_pin.png" class="icon_pin">',
            verticalAlign: 'top',
            horizontalAlign: 'center'
          });
          $('#formcoord1').val(lat);
          $('#formcoord2').val(lng);
        }
    });
    
  GMaps.geolocate({
        success: function(position){
          var lat = position.coords.latitude;
          var lng = position.coords.longitude;
            map.setCenter(lat, lng);
      $('input[name="formcoord1"]').val(lat);
            $('input[name="formcoord2"]').val(lng);
            overlay = map.drawOverlay({
          lat: lat,
            lng: lng,
            /*content: '<div class="overlay"><img src="img/icon_pin.png">EUGEN<div class="overlay_arrow above"></div></div>',*/
            content: '<img src="img/icon_pin.png" class="icon_pin">',
            verticalAlign: 'top',
            horizontalAlign: 'center'
        });
        },
        error: function(error){
          alert('Geolocation failed: '+error.message);
        },
        not_supported: function(){
          $('input[name="formcoord1"]').val("error");
          $('input[name="formcoord2"]').val("error");
          alert("Your browser does not support geolocation");
        },
        always: function(){
        }
    });

	// Checking if user Logged in
	function isLoggedIn() {
		$.ajax({
			type: "GET",
			url: "status",
			success: function(response) {
				if (response.login) {
					setupLogin(response.username);
				}
			}
		});
	}
	isLoggedIn();

	// LOGIN PROCESS
	$("#loginbutton").click(function() {
		var username = $("#username").val();
		var password = $("#password").val();

		$.ajax({
			type: "POST",
			url: "sign_in",
			data: {	username: username,
					password: password
					},
			success: function(response) {
				if (response.success) {
					setupLogin(response.username);
				}
				else
					alert("Login failed ( "+response.message+" ).");
			}
		});
	});
	
	function setupLogin(username) {
		$('#signup_dropdown').empty();
		$('#signin_dropdown').empty();
		$('#signin_dropdown').append(
			'<a id="userDropdownLink" class="dropdown-toggle" href="#" data-toggle="dropdown"><i class="icon-user">'+
            '</i> '+username+'<strong class="caret"></strong></a>' + 
        	'<div id="userDropdown" class="dropdown-menu" style="padding: 5px; padding-bottom: 0px;">'+
            '<li><a href="settings"><i class="icon-wrench"></i> Settings</a></li>'+
            '<li><a href="logout"><i class="icon-remove-sign"></i> Logout</a></li></div>');
	}
	
	/**
	* SEARCH FUNCTION - ajax get request
	*/
	$("#searchbutton").click(function() {
		// Assembling search data
		var searchdata = {
			formcoord1:$("#formcoord1").val(),
			formcoord2:$("#formcoord2").val(),
			formradius:$("#formradius").val()
		};
		$.ajax({
			type: "POST",
			url: "search",
			data: {
				lat: $("#formcoord1").val(),
				lng: $("#formcoord2").val(),
				radius: $("#formradius").val()
			},
			// This function will set the actual elements on the MAP
			success: function(data) {
				map.removeOverlays();
				for(index in data) {
					var tweet = data[index];
					map.drawOverlay({
    					lat: tweet.geo.coordinates[0],
                lng: tweet.geo.coordinates[1],
                content: '<div class="overlay_search"><img src="'+tweet.profile_image+'" width="60px" height="60px" style=" -webkit-border-radius:5px; -moz-border-radius:5px;"><div class="overlay_arrow_search above_search"><div><a href="LINKHERE"><img class="icon_left" src="/img/icon_img.png" width="16px" height="16px"><img class="icon_right" src="/img/icon_fullscreen.png" width="16px" height="16px"></div></div></div>',
                verticalAlign: 'top',
                horizontalAlign: 'center'

    				});
    			}
			}
		});
	});
    
});
</script>
</body>
</html>